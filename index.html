<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚¹ã‚¿ãƒ³ãƒ—ä½œæˆç”»é¢</title>

  <!-- CSS & Tailwind -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="reset.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/flowbite@1.4.4/dist/flowbite.min.css" />

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <!-- fontAwesome -->
  <script src="https://kit.fontawesome.com/e6a146d4cb.js" crossorigin="anonymous"></script>
</head>

<body>

  <!----------------------------------------------
    â­ï¸ã“ã“ãŒå¤§å…ƒï¼ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆãƒ–ãƒ­ãƒƒã‚¯  
    ------------------------------------------------->
  <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-6 pt-8 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
          <div>
            <a href="./tvcha.html">
              <img class="w-40 h-15 mr-2" src="./img/tvcha_logo.png" alt="logo" />
            </a>
          </div>

          <form>
            <div class="flex items-start">
              <div class="w-3/4">
                <div>
                  <h1 class="text-xl font-bold mb-3 leading-tight tracking-tight text-purple-800 md:text-2xl">
                    ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç™»éŒ²ã™ã‚‹
                  </h1>
                </div>
                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->

                <!-- ç”»åƒç™»éŒ² -->
                <div class="w-full flex items-start mt-3 mb-3">
                  <label class="w-1/4 block mt-3 mb-3 text-sm font-medium text-gray-900" for="id">ç”»åƒç™»éŒ²</label>
                  <label class="block">
                    <input
                      class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
                      id="img" type="file" />
                  </label>
                </div>

                <!-- éš ã‚Œè¦ç´ ç™»éŒ² -->
                <div><input type="hidden" id="point" value="0" /></div>
                <div><input type="hidden" id="count" value="0" /></div>
                <div><input type="hidden" id="order" value="0" /></div>
              </div>

              <div>
                <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div id="imagePreview"></div>
              </div>
            </div>

            <button type="button" id="send"
              class="w-full mt-3 mb-3 text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center"
              disabled>
              ç™»éŒ²
            </button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-6 pt-4 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
          <h1 class="text-xl font-bold mb-3 leading-tight tracking-tight text-purple-800 md:text-2xl">
            ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§
          </h1>

          <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°ã‚¨ãƒªã‚¢ -->
          <div class="flex flex-col items-center justify-center">
            <p class="w-full" id="output"></p>
          </div>
        </div>
      </div>

    </div>
  </section>


  <!----------------------------------------------
    â­ï¸é¸æŠã—ãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    ------------------------------------------------->
  <script>
    $("#img").on("change", function () {
      const file = this.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        $("#imagePreview").html(`<img src="${e.target.result}" />`);
      };
      reader.readAsDataURL(file);
    });

    $("#send").click(function () {
      $("#imagePreview").empty();
    });
  </script>

  <script type="module">
    //----------------------------------------
    // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
    //----------------------------------------

    // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

    // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
      onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    const storage = getStorage(app);

    // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const db = getFirestore(app);

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const q = query(collection(db, "tvcha"), orderBy("order", "desc"));

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const device = query(collection(db, "device"), orderBy("order", "desc"));

    //----------------------------------------
    // â–¼ç”»åƒãŒé¸æŠã•ã‚ŒãŸæ™‚ã®ã¿ç™»éŒ²ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚‹
    //----------------------------------------

    $(document).ready(function () {
      function toggleButton() {
        const imgFile = $("#img")[0].files[0]; // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

        if (imgFile) {
          $("#send").prop("disabled", false);
        } else {
          $("#send").prop("disabled", true);
        }
      }

      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
      $("#img").on("change", toggleButton);

      // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      async function getDocumentCount() {
        const snapshot = await getDocs(collection(db, "tvcha"));
        return snapshot.size;
      }

      //----------------------------------------
      // â–¼ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…
      //----------------------------------------

      // ç™»éŒ²ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
      $("#send").on("click", function () {
        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¤å®šã™ã‚‹å‡¦ç†ã¯ã€ä¸Šè¨˜ã®toggleButton()é–¢æ•°ã§è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãã®ã¾ã¾é€ä¿¡å‡¦ç†ã‚’è¡Œã†
        const imgFile = $("#img")[0].files[0]; // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

        // ä»¥ä¸‹ã®å‡¦ç†ã¯ç”»åƒãŒé¸æŠã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹
        const storageRef = ref(storage, "images/" + imgFile.name);
        uploadBytes(storageRef, imgFile)
          .then((snapshot) => {
            return getDownloadURL(snapshot.ref);
          })
          .then(async (downloadURL) => {
            console.log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ URL:", downloadURL);

            // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’å–å¾—
            const documentCount = await getDocumentCount();
            console.log("Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°:", documentCount);

            const postData = {
              img: downloadURL,
              point: Number($("#point").val()),
              count: Number($("#count").val()),
              order: documentCount + 1, // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã«1ã‚’åŠ ãˆã¦orderã¨ã—ã¦ä»˜ç•ª
              time: serverTimestamp(),
            };

            addDoc(collection(db, "tvcha"), postData).then(() => {
              console.log("ãƒ‡ãƒ¼ã‚¿ã‚’ Firestore ã«ä¿å­˜ã—ã¾ã—ãŸ");
              $("#img, #point, #count, #order").val("");
              $("#send").prop("disabled", true); // é€ä¿¡å¾Œã€ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            });
          });
      });

      // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      $("#send").prop("disabled", true);
    });

    //----------------------------------------
    // â–¼å¤‰æ›´ãƒœã‚¿ãƒ³é–¢æ•°
    //----------------------------------------

    function updateFirebaseData(documentId, newPoint) {
      // Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’ä½œæˆ
      const docRef = doc(db, "tvcha", documentId);

      // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹
      updateDoc(docRef, {
        point: newPoint,
      })
        .then(() => {
          console.log("Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
        })
        .catch((error) => {
          console.error(
            "Firebaseã®ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
            error
          );
        });
    }

    // ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ URL ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é–¢æ•°
    function displayImage(downloadURL, element) {
      // ã™ã§ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã™ã‚‹
      while (element.firstChild) {
        element.removeChild(element.firstChild);
      }

      // æ–°ã—ã„ç”»åƒã‚’è¡¨ç¤º
      const img = document.createElement("img");
      img.src = downloadURL;
      element.appendChild(img);
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    onSnapshot(q, (querySnapshot) => {
      const array = [];
      querySnapshot.docs.forEach(function (doc) {
        const document = {
          id: doc.id,
          data: doc.data(),
        };
        array.push(document);
      });

      const pointData = []; // pointDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
      const countData = []; // countDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
      const imageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã

      console.log(array);

      //----------------------------------------
      // id: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ID',
      // data: {
      //      img: 'ç”»åƒã®URL',
      //      point: 'ãƒã‚¤ãƒ³ãƒˆ',
      //      count: 'ã‚«ã‚¦ãƒ³ãƒˆ',
      //      time: 'ä½œæˆæ—¥æ™‚ãªã©'
      // countData : 'ã‚«ã‚¦ãƒ³ãƒˆã®é…åˆ—',
      // imageUrls : 'ç”»åƒã®URLã®é…åˆ—'
      //----------------------------------------

      let tableRows = "";

      array.forEach(function (document, index) {
        const deleteButton = `<button class="delete-btn" data-id="${document.id}"><i class="fas fa-trash"></i></button>`;

        // å¥‡æ•°è¡Œã¨å¶æ•°è¡Œã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        const rowStyleClass = index % 2 === 0 ? "even-row" : "odd-row";

        // indexãŒ0ã®å ´åˆï¼ˆ1è¡Œç›®ã®å ´åˆï¼‰ã¯incrementButtonã‚’è¿½åŠ ã—ãªã„
        const incrementButton =
          index === 0
            ? ""
            : `<button class="increment-btn" data-id="${document.id}"><i class="fa-solid fa-arrow-up"></i></button>`;

        // indexãŒæœ€å¾Œã®è¡Œã§ãªã„å ´åˆã®ã¿decrementButtonã‚’è¿½åŠ 
        const decrementButton =
          index !== array.length - 1
            ? `<button class="decrement-btn" data-id="${document.id}"><i class="fa-solid fa-arrow-down"></i></button>`
            : "";


        // countDataã«document.data.countã‚’è¿½åŠ 
        pointData.push(document.data.point);

        // countDataã«document.data.countã‚’è¿½åŠ 
        countData.push(document.data.count);

        // imageUrlsã«document.data.imgã‚’è¿½åŠ 
        imageUrls.push(document.data.img);

        //----------------------------------------
        // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        //----------------------------------------

        tableRows += `
                    <tr style="height: 46px;" class="${rowStyleClass}">
                        <td>
                            <div class="image_thumnail" id="image-${index}"></div>
                        </td>
                        <td class=point_area>
                            ${document.data.point}
                        </td>
                        <td>${document.data.count}</td>
                        <td>${convertTimestampToDatetime(
          document.data.time
        )}</td>
                        <td>${deleteButton}</td> 
                        <td>${incrementButton} ${decrementButton}</td> 
                    </tr>
                    `;

        // ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ URL ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        getDownloadURL(ref(storage, document.data.img)).then(
          (downloadURL) => {
            const imageElement = $(`#image-${index}`)[0];
            displayImage(downloadURL, imageElement);

            // ç”»åƒè¦ç´ ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            $(imageElement).attr("draggable", true);
          }
        );


      });

      const table = `
                <table class="w-full" id="stampList">
                    <thead>
                    <tr>
                        <th>ã‚¹ã‚¿ãƒ³ãƒ—</th>
                        <th>ãƒã‚¤ãƒ³ãƒˆ</th>
                        <th>ã‚¯ãƒªãƒƒã‚¯æ•°</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>å‰Šé™¤</th>
                        <th>é †åº</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${tableRows}
                    </tbody>
                </table>
                `;
      $("#output").html(table);

      // console.log("countData", countData, "imageUrls", imageUrls);


      //----------------------------------------
      // â–¼ç”»åƒã®æ›´æ–°é–¢æ•°
      //----------------------------------------

      $(".image_thumnail").click(function () {
        const index = $(this).attr("id").split("-")[1]; // ç”»åƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        console.log(index);

        // <input type="file"> è¦ç´ ã‚’ä½œæˆ
        const inputFile = $('<input type="file">');

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸç”»åƒã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—
        const documentId = $(this)
          .closest("tr")
          .find(".delete-btn")
          .data("id");
        console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸç”»åƒã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID:", documentId);

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
        inputFile.change(function () {
          const file = this.files[0]; // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

          // ç”»åƒã‚’è¡¨ç¤º
          const reader = new FileReader();
          reader.onload = function (e) {
            const imgElement = $("<img>").attr("src", e.target.result);
            $(`#image-${index}`).html(imgElement);
          };
          reader.readAsDataURL(file);

          // ç”»åƒã‚’ Firebase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          const storageRef = ref(storage, "images/" + file.name);
          uploadBytes(storageRef, file)
            .then((snapshot) => {
              return getDownloadURL(snapshot.ref);
            })
            .then((downloadURL) => {
              // Firebase Firestoreã®è©²å½“ãƒ‡ãƒ¼ã‚¿ã®ç”»åƒURLã‚’æ›´æ–°ã™ã‚‹
              const docRef = doc(db, "tvcha", documentId);
              console.log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â­ï¸URL:", downloadURL, docRef);
              updateDoc(docRef, {
                img: downloadURL, // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’æŒ‡å®šã—ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
              });
            })
            .catch((error) => {
              console.error(
                "ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
                error
              );
            });
        });
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        inputFile.click();
      });

      //----------------------------------------
      // â–¼ãã®å ´ç·¨é›†ã®å®Ÿè£…
      //----------------------------------------

      $(".point_area").click(function () {
        $(this).addClass("on");
        let txt = $(this).text().trim(); // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒˆãƒªãƒ ã™ã‚‹

        console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã¾ã™", txt);

        const inputElement = $('<input type="text">').val(txt); // <input> è¦ç´ ã‚’ä½œæˆã—ã€å€¤ã‚’è¨­å®š
        inputElement.addClass("input-point"); // ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 

        $(this).empty().append(inputElement); // è¦ç´ ã‚’ä¸€åº¦ç©ºã«ã—ã¦ã‹ã‚‰ <input> è¦ç´ ã‚’è¿½åŠ 

        inputElement
          .focus()
          .keydown(function (event) {
            if (event.which === 13) {
              // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã®ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯13
              event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ”¹è¡Œï¼‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              let inputVal = $(this).val();

              // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«å¤‰æ›
              inputVal = inputVal.replace(/[ï¼-ï¼™]/g, function (s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xfee0);
              });

              // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼šåŠè§’è‹±æ•°å­—ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼
              if (/[^0-9]/.test(inputVal)) {
                alert("åŠè§’è‹±æ•°å­—ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚åŠè§’è‹±æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
              }
              // Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
              const documentId = $(this)
                .closest("tr")
                .find(".delete-btn")
                .data("id");
              updateFirebaseData(documentId, inputVal);

              $(this).parent().removeClass("on").text(inputVal);
            }
          })
          .blur(function () {
            //blurã¨ã¯ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã«ç™ºç”Ÿã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
            let inputVal = $(this).val();

            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼šå…¨è§’æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼
            if (/[^0-9]/.test(inputVal)) {
              alert("åŠè§’è‹±æ•°å­—ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚åŠè§’è‹±æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
              return;
            }

            // Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
            const documentId = $(this)
              .closest("tr")
              .find(".delete-btn")
              .data("id");
            updateFirebaseData(documentId, inputVal);

            $(this).parent().removeClass("on").text(inputVal);
          });

        // ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        inputElement.select();
      });

      // åˆæœŸçŠ¶æ…‹ã§ã¯å‡¦ç†ä¸­ã§ã¯ãªã„ã®ã§ã€isHandlingã‚’falseã«è¨­å®š
      let isHandling = false;

      //----------------------------------------
      // â–¼ã€Œâ†“ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      //----------------------------------------
      $("#output")
        .off("click", ".decrement-btn")
        .on("click", ".decrement-btn", function () {
          const decrementDocId = $(this).data("id");
          handleDecrementOrder(decrementDocId, array);
        });

      //----------------------------------------
      // â–¼ã€Œâ†‘ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      //----------------------------------------

      $("#output")
        .off("click", ".increment-btn")
        .on("click", ".increment-btn", function () {
          isHandling = true; // å‡¦ç†ä¸­ã®ãƒ•ãƒ©ã‚°ã‚’trueã«è¨­å®š
          const incrementDocId = $(this).data("id");
          handleIncrementOrder(incrementDocId, array);
        });

      //----------------------------------------
      // â–¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®æŒ™å‹•
      //----------------------------------------

      $(document)
        .off("click", ".delete-btn")
        .on("click", ".delete-btn", function () {
          const deletedId = $(this).data("id");
          const deletedDocRef = doc(db, "tvcha", deletedId);

          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦orderãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’ç¢ºèª
          getDoc(deletedDocRef).then((deletedDoc) => {
            if (!deletedDoc.exists()) {
              console.log("Document not found!");
              return;
            }

            const deletedOrder = deletedDoc.data().order;
            console.log("deletedOrder:", deletedOrder);
            // å‰Šé™¤æ“ä½œ
            deleteDoc(deletedDocRef);

            // ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®orderãŒdata.orderã‚ˆã‚Šç­‰ã—ã„å ´åˆã«1å¢—ã‚„ã™
            array.forEach((document) => {
              if (document.data.order > deletedOrder) {
                document.data.order -= 1;
                console.log(document.id, document.data.order);

                updateDoc(doc(db, "tvcha", document.id), {
                  order: document.data.order,
                }); // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’æ›´æ–°
              }
            });
          });
        });

    });

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸¦ã³æ›¿ãˆé–¢æ•° â†“ä¸‹ã«ä¸‹ã’ã‚‹
    //----------------------------------------

    // å„è¡Œã®ã€Œâ†“ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    function handleDecrementOrder(decrementDocId, array) {
      // å¯¾å¿œã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const decrementDocRef = doc(db, "tvcha", decrementDocId);

      getDoc(decrementDocRef)
        .then((decrementDoc) => {
          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const decrementData = decrementDoc.data();
          // orderã‚’1æ¸›ã‚‰ã™
          decrementData.order -= 1;
          // console.log(decrementDocId, decrementData.order);

          // Firestoreã«æ›´æ–°ã‚’åæ˜ 
          updateDoc(decrementDocRef, decrementData);

          // ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®orderãŒdata.orderã‚ˆã‚Šç­‰ã—ã„å ´åˆã«1å¢—ã‚„ã™
          array.forEach((document) => {
            if (
              document.id !== decrementDocId &&
              document.data.order === decrementData.order
            ) {
              document.data.order += 1;
              console.log("increment ID", document.id, document.data.order);
              const incrementDocRef = doc(db, "tvcha", document.id); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å–å¾—
              updateDoc(incrementDocRef, {
                order: document.data.order,
              }); // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’æ›´æ–°
            }
          });
        })
        .catch((error) => {
          console.error("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", error);
        });
    }

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸¦ã³æ›¿ãˆé–¢æ•° â†‘ä¸Šã«ä¸Šã’ã‚‹
    //----------------------------------------

    // å„è¡Œã®ã€Œâ†‘ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    function handleIncrementOrder(incrementDocId, array) {
      // å¯¾å¿œã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const incrementDocRef = doc(db, "tvcha", incrementDocId);

      getDoc(incrementDocRef)
        .then((inrementDoc) => {
          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const incrementData = inrementDoc.data();
          // orderã‚’1å¢—ã‚„ã™
          incrementData.order += 1;
          console.log(incrementDocId, incrementData.order);

          // Firestoreã«æ›´æ–°ã‚’åæ˜ 
          updateDoc(incrementDocRef, incrementData);

          // ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®orderãŒdata.orderã‚ˆã‚Šç­‰ã—ã„ã‚‚ã—ãã¯å°‘ãªã„å ´åˆã«1æ¸›ã‚‰ã™
          array.forEach((document) => {
            if (
              document.id !== incrementDocId &&
              document.data.order === incrementData.order
            ) {
              document.data.order -= 1;
              // console.log("decrement ID", document.id, document.data.order);
              const decrementDocRef = doc(db, "tvcha", document.id); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å–å¾—
              updateDoc(decrementDocRef, {
                order: document.data.order,
              }); // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’æ›´æ–°
            }
          });
        })
        .catch((error) => {
          console.error("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", error);
        });
    }


    //----------------------------------------
    // â–¼æ™‚åˆ»å¤‰æ›é–¢æ•°
    //----------------------------------------

    function convertTimestampToDatetime(timestamp) {
      const _d = timestamp ? new Date(timestamp * 1000) : new Date();
      const Y = _d.getFullYear();
      const m = (_d.getMonth() + 1).toString().padStart(2, "0");
      const d = _d.getDate().toString().padStart(2, "0");
      const H = _d.getHours().toString().padStart(2, "0");
      const i = _d.getMinutes().toString().padStart(2, "0");
      const s = _d.getSeconds().toString().padStart(2, "0");
      return `${m}/${d} ${H}:${i}`;
    }
  </script>
</body>

</html>